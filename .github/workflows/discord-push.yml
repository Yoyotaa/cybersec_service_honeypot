name: Discord push alert

on:
  push:
    branches:
      - "*"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        env:
          WEBHOOK: ${{ secrets.WEBHOOK_DISCORD_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
        run: |
          if [ -z "$WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK_URL secret is missing/empty"
            exit 1
          fi

          WEBHOOK="$(printf %s "$WEBHOOK" | tr -d '\r\n')"

          payload="$(jq -n \
            --arg actor "$ACTOR" \
            --arg repo "$REPO" \
            --arg branch "$BRANCH" \
            --arg msg "$COMMIT_MSG" \
            --arg url "$COMMIT_URL" \
            '{
              username: "Honeypot CI",
              embeds: [{
                title: "Push détecté",
                description: ("**" + $actor + "** a push sur **" + $repo + "**"),
                color: 3447003,
                fields: [
                  {name:"Branche", value: ("`" + $branch + "`"), inline:true},
                  {name:"Commit", value: ("[Voir le commit](" + $url + ")"), inline:true},
                  {name:"Message", value: $msg, inline:false}
                ]
              }]
            }'
          )"

          curl -sS -f -H "Content-Type: application/json" \
            --data "$payload" \
            "$WEBHOOK"
